## Переменные окружения

- `OPENAI_API_KEY` — ключ к провайдеру LLM (через OpenRouter/совместимый API)
- `OPENAI_MODEL` — модель LLM (по умолчанию: `tngtech/deepseek-r1t2-chimera:free`)
- `OPENAI_BASE_URL` — базовый URL OpenAI-совместимого API (по умолчанию: `https://openrouter.ai/api/v1`)
- `FLIGHTAPI_BASE_URL` — базовый URL FlightAPI (по умолчанию: `https://api.flightapi.io`)
- `ALLOWED_AIRPORT_CODES` — список IATA-кодов, через запятую (например: `DXB,LHR,CDG`)
- `CACHE_TTL_SECONDS` — время жизни кеша в секундах (по умолчанию: 43200)
- `CACHE_FILE_PATH` — путь к файлу кеша (по умолчанию: `tmp/flight_cache.json`)
- `MEMORY_LEN_MESSAGES` — максимальная длина истории диалога (по умолчанию: 40)

## Установка зависимостей

Через Poetry:

```bash
poetry install
```

## Локальный запуск

```bash
python run.py
```

После запуска откройте браузер на `http://localhost:8080`.

## Docker Compose

Подготовьте `.env` файл (см. `.env.example`) и запустите:

```bash
docker compose up --build
```

Compose маппит `./src/tmp` в контейнерный `/app/tmp`, чтобы кеш сохранялся на хосте и переживал перезапуски. Переменные окружения подхватываются из `.env`.

Важно: `.env` добавлен в `.gitignore`. В репозитории хранится только пример `.env.example` — скопируйте его в `.env` и заполните значения.

## Архитектура LLM-интеграции

- Слой UI (`src/fe.py`):
  - Только отображение и сбор пользовательского ввода.
  - Делегирует бизнес-логику в сервисы.

- Сессии (`src/services/sessions.py`):
  - `SessionData`: хранит состояние пользователя (история LLM, выбранный аэропорт, ключ FlightAPI, экземпляры LLM и API).
  - `SessionManager`: управление жизненным циклом сессий на основе `client_id` из NiceGUI.

- Бизнес-логика (`src/services/assistant.py`):
  - Инициализирует и кеширует зависимости (LLM, Flights API) на уровне сессии.
  - Формирует датасет по рейсам на сегодня, собирает сообщения для LLM, стримит ответ, сохраняет историю.

- Интеграция внешнего API полётов (`src/apis/`):
  - `BaseFlightsApi`: абстрактный интерфейс поставщика.
  - `FlightApi`: реализация под конкретный провайдер (FlightAPI), с TTL-кешем и дампом на диск.

- Конфигурация (`src/configs.py`):
  - `Settings` (Pydantic): значения по умолчанию + переопределения из переменных окружения.
  - Для совместимости экспортируются константы (быстрый доступ без изменения кода).

### Поток обработки запроса

1. Пользователь вводит вопрос и выбирает аэропорт в UI.
2. UI вызывает сервис: ensure_dependencies(session, user_key) → создаются/берутся LLM и Flights API из сессии.
3. Сервис запрашивает данные рейсов за сегодня у Flights API (параллельно прилёты/вылеты), нормализует схему.
4. Сервис собирает системные сообщения + датасет в JSON и добавляет историю.
5. Ответ LLM стримится чанками в UI; по завершении история диалога сохраняется и усекается по лимиту.

### ЧТо улучшить
- Нормализованные данные завернуть в pydantic модель.
- Управлять кешем поумнее, не на 12 часов (сделано для экономии запросов), а до конца текущего часа, например.
- Кеш отнести в сторонний сервис.
- Сессии тоже отнести в сторонний сервис.
